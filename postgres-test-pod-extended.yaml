apiVersion: v1
kind: Pod
metadata:
  name: postgres-test-pod
  labels:
    app: postgres-test
spec:
  containers:
  - name: connectivity-tester
    image: connectivity-tester:latest
    imagePullPolicy: IfNotPresent
    env:
    # PostgreSQL Configuration
    - name: PGHOST
      valueFrom:
        configMapKeyRef:
          name: postgres-config
          key: host
    - name: PGPORT
      valueFrom:
        configMapKeyRef:
          name: postgres-config
          key: port
    - name: PGDATABASE
      valueFrom:
        configMapKeyRef:
          name: postgres-config
          key: database
    - name: PGUSER
      valueFrom:
        configMapKeyRef:
          name: postgres-config
          key: username
    - name: PGPASSWORD
      valueFrom:
        secretKeyRef:
          name: postgres-secret
          key: password
    
    # Azure OpenAI Configuration (Optional)
    - name: AZURE_OPENAI_ENDPOINT
      valueFrom:
        secretKeyRef:
          name: azure-services-secret
          key: azure-openai-endpoint
          optional: true
    - name: AZURE_OPENAI_API_KEY
      valueFrom:
        secretKeyRef:
          name: azure-services-secret
          key: azure-openai-api-key
          optional: true
    - name: AZURE_OPENAI_DEPLOYMENT
      valueFrom:
        secretKeyRef:
          name: azure-services-secret
          key: azure-openai-deployment
          optional: true
    - name: AZURE_OPENAI_API_VERSION
      valueFrom:
        secretKeyRef:
          name: azure-services-secret
          key: azure-openai-api-version
          optional: true
    
    # Azure Document Intelligence Configuration (Optional)
    - name: AZURE_DOCINTEL_ENDPOINT
      valueFrom:
        secretKeyRef:
          name: azure-services-secret
          key: azure-docintel-endpoint
          optional: true
    - name: AZURE_DOCINTEL_API_KEY
      valueFrom:
        secretKeyRef:
          name: azure-services-secret
          key: azure-docintel-api-key
          optional: true
    - name: AZURE_DOCINTEL_API_VERSION
      valueFrom:
        secretKeyRef:
          name: azure-services-secret
          key: azure-docintel-api-version
          optional: true
    
    # Ollama Configuration (Optional)
    - name: OLLAMA_ENDPOINT
      valueFrom:
        secretKeyRef:
          name: azure-services-secret
          key: ollama-endpoint
          optional: true
    - name: OLLAMA_MODEL
      valueFrom:
        secretKeyRef:
          name: azure-services-secret
          key: ollama-model
          optional: true
    
    # OpenAI-compatible Configuration (Optional)
    - name: OPENAI_COMPATIBLE_ENDPOINT
      valueFrom:
        secretKeyRef:
          name: azure-services-secret
          key: openai-compatible-endpoint
          optional: true
    - name: OPENAI_COMPATIBLE_API_KEY
      valueFrom:
        secretKeyRef:
          name: azure-services-secret
          key: openai-compatible-api-key
          optional: true
    - name: OPENAI_COMPATIBLE_MODEL
      valueFrom:
        secretKeyRef:
          name: azure-services-secret
          key: openai-compatible-model
          optional: true
    
    # Custom Hostname Test Configuration (Optional)
    - name: CUSTOM_HOST_1
      valueFrom:
        secretKeyRef:
          name: azure-services-secret
          key: custom-host-1
          optional: true
    - name: CUSTOM_HOST_1_NAME
      valueFrom:
        secretKeyRef:
          name: azure-services-secret
          key: custom-host-1-name
          optional: true
    - name: CUSTOM_HOST_2
      valueFrom:
        secretKeyRef:
          name: azure-services-secret
          key: custom-host-2
          optional: true
    - name: CUSTOM_HOST_2_NAME
      valueFrom:
        secretKeyRef:
          name: azure-services-secret
          key: custom-host-2-name
          optional: true
    - name: CUSTOM_HOST_3
      valueFrom:
        secretKeyRef:
          name: azure-services-secret
          key: custom-host-3
          optional: true
    - name: CUSTOM_HOST_3_NAME
      valueFrom:
        secretKeyRef:
          name: azure-services-secret
          key: custom-host-3-name
          optional: true
    
    # PVC Test Configuration (Optional)
    - name: TEST_PVC
      value: "false"  # Set to "true" to enable PVC testing
    - name: PVC_MOUNT_PATH
      value: "/mnt/test-storage"
    
    volumeMounts:
    - name: test-storage
      mountPath: /mnt/test-storage
    
    resources:
      requests:
        memory: "128Mi"
        cpu: "100m"
      limits:
        memory: "256Mi"
        cpu: "500m"
  
  volumes:
  - name: test-storage
    persistentVolumeClaim:
      claimName: test-pvc
      optional: true  # Pod will still start if PVC doesn't exist